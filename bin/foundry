#!/usr/bin/env ruby

unless $:.include?(File.dirname(__FILE__) + '/../lib')
  $:.unshift(File.dirname(__FILE__) + '/../lib')
end

require 'trollop'
require 'foundry'
require 'pp'

opts = Trollop::options do
  version "Foundry Ruby Interpreter/Compiler #{Foundry::VERSION}"
  banner <<-EOS
Usage: foundry [options] filename...

  EOS

  opt :target,   "Target environment",         :default => 'dummy'
  opt :warn,     "Enable or disable warnings", :type => :strings
  opt :feature,  "Enable or disable features", :type => :strings
  opt :evaluate, "Evaluate code",              :type => :strings
end

class StandaloneInterpreter < Foundry::Interpreter::Ruby
  def on_repl(node)
    repl = Foundry::REPL::Shell.new($runtime, self.outer)
    repl.invoke!

    Foundry::VI::NIL
  end

  def on_trace(node)
    process_all(node.children).each do |arg|
      p arg
    end

    Foundry::VI::NIL
  end
end

Foundry::Runtime.interpreter = StandaloneInterpreter

begin
  $runtime = Foundry::Runtime.new
  $runtime.bootstrap

  $runtime.eval <<-REPL, '(prelude)'
  module Kernel
    def repl!
      Foundry.primitive :repl
    end
  end
  REPL

  $runtime.graph_ir = true

  if opts[:evaluate]
    opts[:evaluate].each do |value|
      $runtime.eval value, '(-e)'
    end
  end

  if ARGV.any? || opts[:evaluate]
    ARGV.each do |input|
      if input == '-'
        $runtime.eval STDIN.read, '(stdin)'
      else
        $runtime.load input
      end
    end
  else
    $runtime.eval 'repl!', '(prelude)'
  end
rescue Foundry::Interpreter::Error => e
  puts "Unhandled exception:"
  puts e.inner_exception.inspect
  puts e.inner_backtrace
  exit!
end